{% extends 'main/layout.html' %}
{% load static %}
{% block title %}Preprocessing{% endblock %}
{% block body %}
    <h2 class="text-center my-4">Upload Your Dataset and Apply Preprocessing</h2>
    <!-- File Upload Form -->

    <div class="d-flex justify-content-center">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- upload dataset here  -->                                
            <div class="mb-3">
                <input type="file" id="file" name="file" accept=".csv" class="form-control" required>
            </div>
            
            <!-- Preprocessing Options -->
            <div class="mb-3">
                <label for="missing_value_strategy">Missing Value Strategy:</label>
                <select id="missing_value_strategy" name="missing_value_strategy" class="form-control">
                    <option value="None">None</option>
                    <option value="mean">Fill with Mean</option>
                    <option value="median">Fill with Median</option>
                    <option value="drop">Remove Rows</option>
                </select>
            </div>

            <!-- Column Selection for Missing Value Strategy -->
            <div class="mb-3">
                <label id="colselect"></label>
                <div id="feature_selection" class="form-check">
                    <!-- Checkboxes will be populated dynamically -->
                </div>
                <button type="button" class="btn btn-primary" id="missing_value_strategybtn">Apply</button>
            </div>
        

            <div class="mb-3">
                <label for="encoding_strategy">Encoding Strategy:</label>
                <select id="encoding_strategy" name="encoding_strategy" class="form-control">
                    <option value="None">None</option>
                    <option value="onehot">One-Hot Encoding</option>
                    <option value="label">Label Encoding</option>
                </select>
            </div>

            <!-- Column Selection for Encoding Strategy -->
            <div class="mb-3">
                <label id="enc_colselect"></label>
                <div id="encoding_selection" class="form-check">
                    <!-- Checkboxes for encoding selection will be populated dynamically -->
                </div>
                <button type="button" class="btn btn-primary" id="encoding_strategybtn">Apply</button>

            </div>

            <div class="mb-3">
                <label for="scaling_strategy">Scaling Strategy:</label>
                <select id="scaling_strategy" name="scaling_strategy" class="form-control">
                    <option value="None">None</option>
                    <option value="standard">Standardization</option>
                    <option value="normalize">Normalization</option>
                </select>
            </div>
            <button type="button" class="btn btn-primary" id="scaling_strategybtn">Apply</button>
            
            <!-- <button type="submit" class="btn btn-primary">Upload and Process</button> -->
        </form>
    </div>
    
    <!-- Conditionally Render the Raw Data Preview Table if Available -->
    {% if data_preview %}
    <h3 class="text-center my-4">Processed Data Preview</h3>
    
    <div class="table-responsive" style="overflow:auto; height:500px; width:100%;">
        {{ data_preview|safe }}
    </div>
    {% else %}
    <h3 class="text-center my-4" id="heading"></h3>
    
    <div id="csv-preview-container" class="table-responsive" style="overflow:auto; height:500px; width:100%;">
        <!-- JavaScript will render data here as table -->
    </div>
    {% endif %}
    <a href="{% url 'download_csv' %}">Download Updated Dataset as CSV</a>

{% endblock %}

{% block script %}
<script>
    document.getElementById('file').addEventListener('change',preview_data);
    function preview_data(e){

    const file = e.target.files[0];
    const formData = new FormData();
    formData.append('file', file);
    

    fetch('/preprocessing', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken'), // Use a helper function to get CSRF token
        },
    })
    .then(response => {
    console.log(response); // Check the entire response object
    return response.json();
})
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // Update the dataset preview with the scaled data
            document.getElementById('csv-preview-container').innerHTML = data.data_preview;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });



    if (file) {
        document.getElementById('heading').innerHTML = "Data Preview";
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split('\n');
            const headers = rows[0].split(','); // Get the headers (first row)

            // Track columns that contain empty cells
            let emptyColumns = new Array(headers.length).fill(false);

            // Preview CSV in a table
            let table = '<table class="table table-bordered table-hover table-striped">';

            // Iterate over the rows
            rows.forEach((row, rowIndex) => {
                const cells = row.split(',');
                let rowClass = '';

                // Check if any cell in the row is empty and mark the row as dangerous
                if (cells.some((cell, colIndex) => {
                    if (cell.trim() === '') {
                        emptyColumns[colIndex] = true; // Mark column as having an empty cell
                        return true;
                    }
                    return false;
                })) {
                    rowClass = 'bg-danger'; // Mark row as dangerous
                }
                

                // Start creating the table rows
                table += `<tr class="${rowClass}">`;
                cells.forEach((cell, colIndex) => {
                    if (rowIndex === 0) {
                        // Highlight header if that column contains at least one empty cell
                        let headerClass = emptyColumns[colIndex] ? 'bg-warning' : '';

                        table += `<th class="" id="${colIndex}">${cell}</th>`;
                    } else {
                        table += `<td>${cell}</td>`;
                    }
                });
                table += '</tr>';
            });

            table += '</table>';
            document.getElementById('csv-preview-container').innerHTML = table;
            
            // to highlight the column name as yellow
            console.log(emptyColumns);
            headers.forEach((header, colIndex) => {
                if (emptyColumns[colIndex]) {
                    console.log(colIndex);
                    document.getElementById(colIndex).classList.add('bg-warning'); // Adjusted for numeric IDs
                }
            });
            
            
            
            
            // Populate the column selection for missing value strategy
            document.getElementById("colselect").innerHTML = "Select Columns for Missing Value Strategy";
            const featureSelectionDiv = document.getElementById('feature_selection');
            featureSelectionDiv.innerHTML = ''; // Clear previous checkboxes
            headers.forEach((header, colIndex) => {
                if (emptyColumns[colIndex]) {
                const checkboxId = `column_${header.trim()}`;
                const checkbox = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="feature_selection" value="${header.trim()}" id="${checkboxId}">
                        <label class="form-check-label" for="${checkboxId}">
                            ${header.trim()}
                        </label>
                    </div>`;
                featureSelectionDiv.innerHTML += checkbox;
                }
            });


            // Populate the column selection for encoding strategy
            document.getElementById("enc_colselect").innerHTML = "Select Columns for Encoding Strategy";
            const encodingSelectionDiv = document.getElementById('encoding_selection');
            encodingSelectionDiv.innerHTML = ''; // Clear previous checkboxes
            headers.forEach(header => {
                const checkboxId = `enc_column_${header.trim()}`;
                const checkbox = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="encoding_selection" value="${header.trim()}" id="${checkboxId}">
                        <label class="form-check-label" for="${checkboxId}">
                            ${header.trim()}
                        </label>
                    </div>`;
                encodingSelectionDiv.innerHTML += checkbox;
            });
        };
        reader.readAsText(file);
    }
}
function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

function applyMissingValueStrategy() {
    const strategy = document.getElementById("missing_value_strategy").value;
    const selectedColumns = Array.from(document.querySelectorAll('input[name="feature_selection"]:checked'))
        .map(input => input.value);
    console.log(strategy);
    console.log(selectedColumns);

    fetch('/preprocessing/fill-missing/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),  // Use a helper function to get CSRF token
        },
        body: JSON.stringify({
            strategy: strategy,
            columns: selectedColumns
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // Update the dataset preview
            document.getElementById('csv-preview-container').innerHTML = data.data_preview;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Call this function when the user applies the missing value strategy
document.getElementById('missing_value_strategybtn').addEventListener('click', applyMissingValueStrategy);


//Encoding strategy
function encoding() {
    const strategy = document.getElementById("encoding_strategy").value;
    const selectedColumns = Array.from(document.querySelectorAll('input[name="encoding_selection"]:checked'))
        .map(input => input.value);

    


    fetch('/preprocessing/encoding/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),  // Use a helper function to get CSRF token
        },
        body: JSON.stringify({
            strategy: strategy,
            columns: selectedColumns
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // Update the dataset preview
            document.getElementById('csv-preview-container').innerHTML = data.data_preview;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Call this function when the user applies the encoding strategy
document.getElementById('encoding_strategybtn').addEventListener('click', encoding);


//scaling strategy

function applyScalingStrategy() {
    const scalingStrategy = document.getElementById("scaling_strategy").value;

    fetch('/preprocessing/scaling/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),  // Use a helper function to get CSRF token
        },
        body: JSON.stringify({
            strategy: scalingStrategy
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // Update the dataset preview with the scaled data
            document.getElementById('csv-preview-container').innerHTML = data.data_preview;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Call this function when the user applies the scaling strategy
document.getElementById('scaling_strategybtn').addEventListener('click', applyScalingStrategy);





</script>
{% endblock %}
